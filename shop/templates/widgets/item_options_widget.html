{% include "django/forms/widgets/input.html" %}

<style>
    .option-badge {
        display: inline-flex;
        padding: 0.35em 0.65em;
        line-height: 1;
        color: #fff;
        text-align: center;
        align-self: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.25rem;
        background-color: #264b5d;
    }

    .option-badge-text {
        align-self: center;
        margin-right: 5px;
    }
</style>

<div class="inline-group">
    <fieldset class="module ">
        <h2>옵션 추가하기</h2>

        <div class="options-input-block">
        </div>

        <div class="add-row">
            <a href="#">옵션 추가하기</a>
        </div>

        <div class="submit-row" style="margin: 20px 0 0 !important;">
            <input type="button" value="모든 옵션 품목 추가" id="add-all-option-btn" class="default">
        </div>
    </fieldset>
</div>

<script>
    document.querySelector('.field-options label').remove();

    class Option {
        constructor() {
            this.optionsInlineCount = 0;
            this. optionObject = new Object();;
        }

        makeOptionBadge(data, id) {
            const badgeDeleteBtn = document.querySelectorAll(
                `#id_option_result_${id} .option-badge-delete`).length;

            return `
                <span class="option-badge">
                    <span class="option-badge-text">
                        ${data}
                    </span>
                    <a href="#"
                        id="option_badge_delete_${id}_${badgeDeleteBtn+1}"
                        class="inline-deletelink option-badge-delete"
                        data-id="${id}">
                        삭제하기
                    </a>
                </span>
            `
        }

        makeAddOptionEle() {
            const id = this.optionsInlineCount;
            return `
                <div id="inline_related_${id}" class="inline-related" data-id=${id}>
                    <h3>
                        <b>옵션 품목:</b>
                        <span class="inline_label">#${id}</span>
                        <a href="#"
                            id="option_input_delete_${id}" 
                            class="inline-deletelink" 
                            data-id=${id}>
                            삭제하기
                        </a>
                    </h3>

                    <fieldset class="module aligned ">
                        <div class="option-input-inner" style="display: flex;">
                            <div class="form-row" style="flex-grow: 0;">
                                <input 
                                    type="text" 
                                    id="id_option_name_${id}"
                                    class="class_option_name" 
                                    placeholder="옵션명 입력"
                                    data-id=${id}>
                            </div>
                            <div class="form-row" style="flex-grow: 2;">
                                <input 
                                    type="text"
                                    id="id_option_value_${id}" 
                                    class="class_option_value" 
                                    placeholder="옵션값 입력 - 엔터" 
                                    style="width: 99.5%;"
                                    data-id=${id}>
                            </div>
                        </div>
                        <div id="id_option_result_${id}" class="form-row option-result">
                        </div>
                    </fieldset>
                </div>
            `
        }

        arrayProduct(...arrays) {
            return arrays[0].reduce((prevAccumulator, currentArray) => {
                let newAccumulator = new Array();

                prevAccumulator.forEach(prevAccumulatorArray => {
                    currentArray.forEach(currentValue => {
                        newAccumulator.push(prevAccumulatorArray.concat(currentValue));
                    });
                });

                return newAccumulator;
            }, [[]]);
        }

        setOptionAttr(elements) {
            elements.forEach(e => {
                const prevId = parseInt(e.getAttribute('data-id'));
                const currentId = prevId - 1;

                const inputDelet = e.querySelector('.inline-deletelink');
                const inputName = e.querySelector('.class_option_name');
                const inputValue = e.querySelector('.class_option_value');

                e.querySelector('.option-result').setAttribute('id', `id_option_result_${currentId}`);
                e.setAttribute('id', `inline_related_${currentId}`);
                e.setAttribute('data-id', `${currentId}`);
                e.querySelector('.inline_label').innerText = `${currentId}`;

                inputDelet.setAttribute('id', `option_input_delete_${currentId}`);
                inputDelet.setAttribute('data-id', `${currentId}`);

                inputName.setAttribute('id', `id_option_name_${currentId}`);
                inputName.setAttribute('data-id', `${currentId}`);

                inputValue.setAttribute('id', `id_option_value_${currentId}`);
                inputValue.setAttribute('data-id', `${currentId}`);

                this.setOptionBadgeAttr(currentId);
            });
        }

        setOptionBadgeAttr(parentId) {
            document.querySelectorAll(`#id_option_result_${parentId} .option-badge`).forEach(e => {
                const aTag = e.querySelector('.option-badge-delete');
                const id = aTag.getAttribute('id').slice(-1);

                aTag.setAttribute('id', `option_badge_delete_${parentId}_${id}`);
                aTag.setAttribute('data-id', parentId);
            })
        }

        optionRename(id) {
            const currentID = parseInt(id);
            const options = document.querySelectorAll('.options-input-block .inline-related');
            const lastID = parseInt(options[options.length-1].getAttribute('id').slice(-1));

            if (currentID < lastID) {
                this.setOptionAttr(Array.from(options).slice(currentID-1));
                this.optionNameHandler();
            }
        }

        optionNameHandler() {
            document.querySelectorAll('.class_option_name').forEach(ele => {
                ele.addEventListener('keydown', e => {
                    if (e.keyCode === 13) {
                        e.preventDefault();
                    };
                });
            });
        }

        optionValueHandler() {
            document.getElementById(`id_option_value_${this.optionsInlineCount}`).addEventListener('keydown', e => {
                if (e.keyCode === 13) {
                    e.preventDefault();

                    const valueInput = e.target;
                    const id = e.target.getAttribute('data-id');
                    const nameInput = document.getElementById(`id_option_name_${id}`);

                    if (nameInput.value === '') {
                        alert('옵션명을 입력해주세요.');
                        return false; 
                    }  

                    if (valueInput.value === '') {
                        alert('옵션값을 입력해주세요.');
                        return false;
                    }

                    if (!(nameInput.value in this.optionObject)) {
                        this.optionObject[nameInput.value] = new Array();
                    } 

                    this.optionObject[nameInput.value].push(valueInput.value);

                    document.getElementById(`id_option_result_${id}`).insertAdjacentHTML(
                        'beforeend', this.makeOptionBadge(valueInput.value, id));
                    valueInput.value = '';

                    const badgeDeleteBtn = document.querySelectorAll(
                        `#id_option_result_${id} .option-badge-delete`).length;

                    document.getElementById(
                        `option_badge_delete_${id}_${badgeDeleteBtn}`).addEventListener('click', e => this.optionBadgeDelete(e));
                }; 
            });
        }

        addOption() {
            document.querySelector('.field-options .add-row').addEventListener('click', e => {
                e.preventDefault();

                this.optionsInlineCount = this.optionsInlineCount + 1;

                document.querySelector('.field-options .options-input-block'
                    ).insertAdjacentHTML('beforeend', this.makeAddOptionEle(e));

                this.optionInputDelete();
                this.optionNameHandler();
                this.optionValueHandler();
            });
        }

        addAllOption() {
            document.getElementById('add-all-option-btn').addEventListener('click', e => {
                const optionArray = new Array();
                const options = document.getElementById('id_options');
                const keys = Object.keys(this.optionObject);

                if (keys.length === 0) {
                    alert('추가된 옵션이 없습니다. 옵션을 먼저 추가해주세요.');
                    return false;
                }

                options.value = JSON.stringify(this.optionObject);

                this.arrayProduct(Object.values(this.optionObject)).forEach((ele, i) => {
                    document.querySelector('#itemreal_item-group .add-row a').click();
                    document.getElementById(`id_itemreal_item-${i}-name`).value = ele.join('/');
                });
            });
        }

        optionInputDelete() {
            document.getElementById(
                `option_input_delete_${this.optionsInlineCount}`).addEventListener('click', e => {
                    e.preventDefault();
                    const id = e.target.getAttribute('data-id');
                    const key = document.getElementById(`id_option_name_${id}`).value;

                    delete this.optionObject[key];

                    document.getElementById(`inline_related_${id}`).remove();
                    this.optionsInlineCount = this.optionsInlineCount - 1;

                    this.optionRename(id);
                }
            );
        }

        optionBadgeDelete(e) {
            e.preventDefault();

            const id = e.target.getAttribute('data-id');
            const key = document.getElementById(`id_option_name_${id}`).value;
            const value = e.currentTarget.previousElementSibling.innerText;

            if (value !== 'undefined') {
                const idx = this.optionObject[key].indexOf(value);

                if (idx > -1) { 
                    this.optionObject[key].splice(idx, 1); 

                    if (this.optionObject[key].length == 0) {
                        delete this.optionObject[key];
                    }
                }

                e.currentTarget.parentNode.remove();
            }
        }
    }

    const option = new Option();
    option.addOption();
    option.addAllOption();
</script>